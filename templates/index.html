<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>kAIcad - AI-Powered KiCad Assistant</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 1rem;
      color: #333;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    header p {
      font-size: 1.1rem;
      opacity: 0.95;
    }
    
    input, textarea, button, select { 
      font: inherit; 
      border: none;
      outline: none;
    }
    
    label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input[type="text"],
    input[type="password"],
    textarea, 
    select { 
      width: 100%; 
      padding: 0.75rem 1rem; 
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
      background: #fafafa;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea { 
      resize: vertical;
      font-family: 'Consolas', 'Monaco', monospace;
      line-height: 1.5;
    }
    
    button {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
      font-size: 0.95rem;
      pointer-events: auto;
      position: relative;
    }
    
    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button:not(:disabled):active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      border: 2px solid #e0e0e0;
    }
    
    .flash { 
      padding: 1rem 1.5rem; 
      border-radius: 8px; 
      margin: 1rem; 
      animation: slideDown 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .flash.error { 
      background: #fee; 
      color: #c33; 
      border-left: 4px solid #c33;
    }
    
    .flash.success { 
      background: #efe; 
      color: #2a7; 
      border-left: 4px solid #2a7;
    }
    
    .flash.warning {
      background: #fffbe6;
      color: #d48806;
      border-left: 4px solid #d48806;
    }
    
    .flash.error::before { content: "‚ö†Ô∏è"; }
    .flash.success::before { content: "‚úì"; }
    .flash.warning::before { content: "‚ö°"; }
    
    .card { 
      background: white;
      border-radius: 12px; 
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    
    .card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .muted { 
      color: #999; 
      font-size: 0.9rem;
      line-height: 1.6;
    }
    
    /* Tabs */
    .tabs { 
      display: flex; 
      background: #f8f9fa;
      padding: 0.5rem;
      gap: 0.5rem;
      border-bottom: none;
      position: relative;
      z-index: 10;
    }
    
    .tab { 
      padding: 1rem 2rem; 
      cursor: pointer; 
      border: none; 
      background: transparent;
      border-radius: 8px;
      transition: all 0.2s; 
      font-weight: 600;
      color: #666;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
    }
    
    .tab:hover { 
      background: #e9ecef;
    }
    
    .tab.active { 
      background: white;
      color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .tab-content { 
      display: none; 
      padding: 2rem;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active { 
      display: block; 
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Grid Layout */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    }
    
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .tab {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
    }
    
    /* Chat Styles */
    #chat-history {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #e0e0e0;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      background: #fafafa;
      scroll-behavior: smooth;
    }
    
    .chat-message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .chat-message.user {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
    }
    
    .chat-message.assistant {
      background: #f3e5f5;
      border-left: 4px solid #9c27b0;
    }
    
    .chat-message strong {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .chat-message.user strong {
      color: #1976d2;
    }
    
    .chat-message.assistant strong {
      color: #7b1fa2;
    }
    
    .chat-message p {
      margin: 0;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    
    /* Status Badge */
    .status-box {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    .status-box p {
      margin: 0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-box strong {
      color: #667eea;
    }
    
    /* Button Groups */
    .button-group {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #764ba2;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚ö° kAIcad</h1>
      <p>AI-Powered KiCad Schematic Assistant</p>
    </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- Tabs -->
  <div class="tabs">
    <button type="button" class="tab active" onclick="switchTab(event, 'workspace')">üé® Workspace</button>
    <button type="button" class="tab" onclick="switchTab(event, 'settings')">‚öôÔ∏è Settings</button>
  </div>

  <form method="post" enctype="multipart/form-data" autocomplete="off">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Workspace Tab -->
    <div id="workspace-tab" class="tab-content active">
      <div class="grid" style="grid-template-columns: 1fr;">
        <div class="card">
          <h2>üí¨ Chat with AI</h2>
          <div id="chat-history">
            {% if chat_history %}
              {% for msg in chat_history %}
                <div class="chat-message {{ msg.role }}">
                  <strong>{{ msg.role|title }}</strong>
                  <p>{{ msg.content }}</p>
                </div>
              {% endfor %}
            {% else %}
              <p class="muted" style="text-align: center; padding: 0.5rem;">Start a conversation about your schematic changes...</p>
            {% endif %}
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.75rem; align-items: end; margin-bottom: 0.75rem;">
            <div>
              <label for="chat_message">Your Message</label>
              <textarea id="chat_message" name="chat_message" placeholder="Ask about component selection, best practices, circuit design..." style="min-height: 4rem;" {% if not has_api_key %}disabled{% endif %}></textarea>
            </div>
            <div>
              <label for="chat_model">Chat Model</label>
              <select id="chat_model" name="chat_model" {% if not has_api_key %}disabled{% endif %}>
                {% for model in chat_models %}
                  <option value="{{ model }}" {% if model == current_chat_model %}selected{% endif %}>{{ model }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <button id="send-btn" type="button" onclick="sendChatMessage()" class="btn-primary" {% if not has_api_key %}disabled{% endif %}>
              <span id="send-btn-text">üì§ Send</span>
            </button>
            <button name="action" value="clear_chat" type="submit" class="btn-danger">
              üóëÔ∏è Clear
            </button>
            <div id="chat-status" style="display: none; padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: 600; font-size: 0.9rem; animation: pulse 1.5s ease-in-out infinite;">
              <span class="spinner"></span> AI is thinking...
            </div>
          </div>
          
          {% if not has_api_key %}
          <p class="muted" style="margin-top: 0.75rem;">‚ö† Configure API key in Settings tab to enable AI features</p>
          {% endif %}
        </div>
      </div>
      
      <div class="grid grid-2">
        <div class="card">
          <h2>üéØ Generate Plan</h2>
          <label for="prompt">Describe Your Changes</label>
          <div style="position: relative;">
            <textarea id="prompt" name="prompt" placeholder="Example: Add LED with 1k resistor connected to VCC and GND" style="min-height: 6rem; padding-right: 50px;" {% if not has_api_key %}disabled{% endif %}></textarea>
            <button type="button" id="expand-btn" onclick="expandWithGPT()" class="btn-secondary" style="position: absolute; right: 8px; top: 8px; padding: 0.5rem; font-size: 1.2rem; line-height: 1;" title="Expand with AI" {% if not has_api_key %}disabled{% endif %}>
              ü§ñ
            </button>
          </div>
          <p class="muted" style="margin-top: 0.5rem; font-size: 0.85rem;">üí° Click ü§ñ to let AI expand your brief idea into a detailed plan</p>
          
          <label for="model">AI Model</label>
          <select id="model" name="model" {% if not has_api_key %}disabled{% endif %}>
            {% for model in available_models %}
              <option value="{{ model }}" {% if model == current_model %}selected{% endif %}>{{ model }}</option>
            {% endfor %}
          </select>
          
          <div class="button-group">
            <button name="action" value="plan" type="submit" class="btn-primary" {% if not has_api_key %}disabled{% endif %}>
              ‚ú® Generate Plan
            </button>
          </div>
        </div>
      </div>
      
      <div class="grid" style="grid-template-columns: 1fr;">
        <div class="card">
          <h2>üìã Plan JSON</h2>
          <label for="plan_json">Review & Edit Plan</label>
          <textarea id="plan_json" name="plan_json" placeholder="Generated plan JSON will appear here..." style="min-height: 12rem;">{{ plan_json or '' }}</textarea>
          <div class="button-group">
            <button name="action" value="load_schematic" type="submit" class="btn-success">
              üìÇ Load Schematic
            </button>
            <button name="action" value="apply" type="submit" class="btn-primary">
              ‚úÖ Apply Plan + Export
            </button>
          </div>
          <p class="muted" style="margin-top: 0.75rem;">
            üíæ On apply: Schematic is automatically backed up as .kicad_sch.bak ‚Ä¢ ERC, Netlist, and PDF are generated
          </p>
        </div>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="grid-2">
        <div class="card">
          <h2>üìÅ Project Configuration</h2>
          <label for="project">KiCad Project File Path</label>
          <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
            <input type="text" id="project" name="project" value="{{ project }}" placeholder="C:\path\to\your\project.kicad_pro" style="flex: 1;" />
            <button name="action" value="detect" type="submit" class="btn-secondary" style="white-space: nowrap;">
              ÔøΩ Detect
            </button>
          </div>
          <p class="muted" style="margin-top: 0.5rem;">
            üí° Paste the full path to your .kicad_pro or .kicad_sch file and click Detect<br>
            <strong>Example:</strong> C:\Users\YourName\Documents\MyProject\MyProject.kicad_pro
          </p>
          
          <div class="status-box">
            <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #666;">üìä Status:</p>
            <p style="margin: 0.25rem 0;">Project: <strong>{{ project_name or '‚Äî' }}</strong></p>
            <p style="margin: 0.25rem 0;">Schematic: <strong>{{ sch_name or '‚Äî' }}</strong></p>
          </div>
          
          <div class="button-group" style="margin-top: 1rem;">
            {% if sch_name %}
            <button name="action" value="launch" type="submit" class="btn-primary">
              üöÄ Launch KiCad
            </button>
            {% else %}
            <button name="action" value="detect" type="submit" class="btn">
              üîç Detect Schematic
            </button>
            {% endif %}
          </div>
        </div>
        
        <div class="card">
          <h2>üîë API Configuration</h2>
          <label for="api_key">OpenAI API Key</label>
          <div style="display: flex; gap: 0.75rem; align-items: flex-start; margin-bottom: 0.75rem;">
            <input type="password" id="api_key" name="api_key" value="{{ api_key_masked }}" placeholder="sk-..." style="flex: 1;" autocomplete="new-password" />
            <button name="action" value="save_key" type="submit" class="btn-success" style="white-space: nowrap;">
              üíæ Save Key
            </button>
          </div>
          <div class="status-box">
            {% if has_api_key %}
            <p style="margin: 0; color: #28a745;">‚úì API key configured and encrypted</p>
            {% else %}
            <p style="margin: 0; color: #dc3545;">‚ö† No API key set - AI features disabled</p>
            {% endif %}
          </div>
          <p class="muted" style="margin-top: 1rem;">
            üîí Your API key is encrypted and stored locally<br>
            ü§ñ Required for AI-powered plan generation
          </p>
        </div>
      </div>
    </div>
  </form>
  
  <script>
    function switchTab(event, tabName) {
      event.preventDefault();
      event.stopPropagation();
      
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.currentTarget.classList.add('active');
    }
    
    // Expand prompt with GPT
    async function expandWithGPT() {
      const promptField = document.getElementById('prompt');
      const expandBtn = document.getElementById('expand-btn');
      const userInput = promptField.value.trim();
      
      if (!userInput) {
        alert('Please enter some text first (e.g., "LED circuit" or "voltage regulator")');
        return;
      }
      
      // Show loading state
      expandBtn.disabled = true;
      expandBtn.textContent = '‚è≥';
      
      try {
        // Get CSRF token from the form
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
        
        const response = await fetch('/generate_description', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
            input: userInput,
            model: document.getElementById('model')?.value || 'gpt-5-mini'
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.description) {
          promptField.value = data.description;
        } else {
          alert('Error: ' + (data.message || 'Failed to generate description'));
        }
      } catch (error) {
        console.error('Error expanding with GPT:', error);
        alert('Error: ' + error.message);
      } finally {
        expandBtn.disabled = false;
        expandBtn.textContent = 'ü§ñ';
      }
    }
    
    // Send chat message via AJAX
    async function sendChatMessage() {
      const chatMessage = document.getElementById('chat_message');
      const sendBtn = document.getElementById('send-btn');
      const sendBtnText = document.getElementById('send-btn-text');
      const chatStatus = document.getElementById('chat-status');
      const chatHistory = document.getElementById('chat-history');
      const chatModel = document.getElementById('chat_model');
      
      const message = chatMessage?.value.trim();
      if (!message) {
        return;
      }
      
      // Show loading state
      if (sendBtn) sendBtn.disabled = true;
      if (sendBtnText) sendBtnText.textContent = '‚è≥ Sending...';
      if (chatStatus) chatStatus.style.display = 'flex';
      
      try {
        console.log('Sending chat message:', message);
        
        // Get CSRF token from the form
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
        
        const response = await fetch('/send_chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
            message: message,
            chat_model: chatModel?.value || 'gpt-5'
          })
        });
        
        console.log('Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success && data.assistant_message) {
          // Add user message to chat
          const userMsgDiv = document.createElement('div');
          userMsgDiv.className = 'chat-message user';
          userMsgDiv.innerHTML = '<strong>User</strong><p>' + escapeHtml(message) + '</p>';
          chatHistory.appendChild(userMsgDiv);
          
          // Add assistant message to chat
          const assistantMsgDiv = document.createElement('div');
          assistantMsgDiv.className = 'chat-message assistant';
          assistantMsgDiv.innerHTML = '<strong>Assistant</strong><p>' + escapeHtml(data.assistant_message) + '</p>';
          chatHistory.appendChild(assistantMsgDiv);
          chatHistory.scrollTop = chatHistory.scrollHeight;
          
          // Clear input after successful send
          chatMessage.value = '';
        } else {
          alert('Error: ' + (data.message || 'Failed to send message'));
          // Don't clear message on error so user can retry
        }
      } catch (error) {
        console.error('Error sending chat message:', error);
        alert('Failed to send message:\n' + error.message + '\n\nPlease check:\n1. Server is running on http://127.0.0.1:5173\n2. API key is configured\n3. Check browser console (F12) for details');
        // Don't clear message on error
      } finally {
        // Always restore UI state
        if (sendBtn) sendBtn.disabled = false;
        if (sendBtnText) sendBtnText.textContent = 'üì§ Send';
        if (chatStatus) chatStatus.style.display = 'none';
      }
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Allow Enter key to send message (Shift+Enter for new line)
    document.addEventListener('DOMContentLoaded', function() {
      const chatMessage = document.getElementById('chat_message');
      const chatHistory = document.getElementById('chat-history');
      
      if (chatMessage) {
        chatMessage.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });
      }
      
      // Auto-scroll chat to bottom on page load
      if (chatHistory) {
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
    });
  </script>
</body>
</html>
